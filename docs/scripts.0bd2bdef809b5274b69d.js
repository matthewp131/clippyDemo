!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],i):t.clippy=i(t.$)}(this,function(t){"use strict";t="default"in t?t.default:t;var i=function(t){this._queue=[],this._onEmptyCallback=t};i.prototype.queue=function(t){this._queue.push(t),1!==this._queue.length||this._active||this._progressQueue()},i.prototype._progressQueue=function(){if(this._queue.length){var i=this._queue.shift();this._active=!0,i(t.proxy(this.next,this))}else this._onEmptyCallback()},i.prototype.clear=function(){this._queue=[]},i.prototype.next=function(){this._active=!1,this._progressQueue()};var e=function(i,e,o,n){this._el=i,this._data=o,this._path=e,this._currentFrameIndex=0,this._currentFrame=void 0,this._exiting=!1,this._currentAnimation=void 0,this._endCallback=void 0,this._started=!1,this._sounds={},this.currentAnimationName=void 0,this.preloadSounds(n),this._overlays=[this._el];var s=this._el;this._setupElement(this._el);for(var a=1;a<this._data.overlayCount;a++){var r=this._setupElement(t("<div></div>"));s.append(r),this._overlays.push(r),s=r}};e.prototype._setupElement=function(t){var i=this._data.framesize;return t.css("display","none"),t.css({width:i[0],height:i[1]}),t.css("background","url('"+this._path+"/map.png') no-repeat"),t},e.prototype.animations=function(){var t=[],i=this._data.animations;for(var e in i)t.push(e);return t},e.prototype.preloadSounds=function(t){for(var i=0;i<this._data.sounds.length;i++){var e=this._data.sounds[i],o=t[e];o&&(this._sounds[e]=new Audio(o))}},e.prototype.hasAnimation=function(t){return!!this._data.animations[t]},e.prototype.exitAnimation=function(){this._exiting=!0},e.prototype.showAnimation=function(t,i){return this._exiting=!1,!!this.hasAnimation(t)&&(this._currentAnimation=this._data.animations[t],this.currentAnimationName=t,this._started||(this._step(),this._started=!0),this._currentFrameIndex=0,this._currentFrame=void 0,this._endCallback=i,!0)},e.prototype._draw=function(){var t=[];this._currentFrame&&(t=this._currentFrame.images||[]);for(var i=0;i<this._overlays.length;i++)if(i<t.length){var e=t[i];this._overlays[i].css({"background-position":-e[0]+"px "+-e[1]+"px",display:"block"})}else this._overlays[i].css("display","none")},e.prototype._getNextAnimationFrame=function(){if(this._currentAnimation){if(!this._currentFrame)return 0;var t=this._currentFrame,i=this._currentFrame.branching;if(this._exiting&&void 0!==t.exitBranch)return t.exitBranch;if(i)for(var e=100*Math.random(),o=0;o<i.branches.length;o++){var n=i.branches[o];if(e<=n.weight)return n.frameIndex;e-=n.weight}return this._currentFrameIndex+1}},e.prototype._playSound=function(){var t=this._currentFrame.sound;if(t){var i=this._sounds[t];i&&i.play()}},e.prototype._atLastFrame=function(){return this._currentFrameIndex>=this._currentAnimation.frames.length-1},e.prototype._step=function(){if(this._currentAnimation){var i=Math.min(this._getNextAnimationFrame(),this._currentAnimation.frames.length-1),o=!this._currentFrame||this._currentFrameIndex!==i;this._currentFrameIndex=i,this._atLastFrame()&&this._currentAnimation.useExitBranching||(this._currentFrame=this._currentAnimation.frames[this._currentFrameIndex]),this._draw(),this._playSound(),this._loop=window.setTimeout(t.proxy(this._step,this),this._currentFrame.duration),this._endCallback&&o&&this._atLastFrame()&&this._endCallback(this.currentAnimationName,this._currentAnimation.useExitBranching&&!this._exiting?e.States.WAITING:e.States.EXITED)}},e.prototype.pause=function(){window.clearTimeout(this._loop)},e.prototype.resume=function(){this._step()},e.States={WAITING:1,EXITED:0};var o=function(t){this._targetEl=t,this._hidden=!0,this._setup(),this.WORD_SPEAK_TIME=200,this.CLOSE_BALLOON_DELAY=2e3,this._BALLOON_MARGIN=15};o.prototype._setup=function(){this._balloon=t('<div class="clippy-balloon"><div class="clippy-tip"></div><div class="clippy-content"></div></div> ').hide(),this._content=this._balloon.find(".clippy-content"),t(document.body).append(this._balloon)},o.prototype.reposition=function(){for(var t=["top-left","top-right","bottom-left","bottom-right"],i=0;i<t.length&&(this._position(t[i]),this._isOut());i++);},o.prototype._position=function(i){var e=this._targetEl.offset(),o=this._targetEl.height(),n=this._targetEl.width();e.top-=t(window).scrollTop(),e.left-=t(window).scrollLeft();var s,a,r=this._balloon.outerHeight(),h=this._balloon.outerWidth();switch(this._balloon.removeClass("clippy-top-left"),this._balloon.removeClass("clippy-top-right"),this._balloon.removeClass("clippy-bottom-right"),this._balloon.removeClass("clippy-bottom-left"),i){case"top-left":s=e.left+n-h,a=e.top-r-this._BALLOON_MARGIN;break;case"top-right":s=e.left,a=e.top-r-this._BALLOON_MARGIN;break;case"bottom-right":s=e.left,a=e.top+o+this._BALLOON_MARGIN;break;case"bottom-left":s=e.left+n-h,a=e.top+o+this._BALLOON_MARGIN}this._balloon.css({top:a,left:s}),this._balloon.addClass("clippy-"+i)},o.prototype._isOut=function(){var i=this._balloon.offset(),e=this._balloon.outerHeight(),o=this._balloon.outerWidth(),n=t(window).width(),s=t(window).height(),a=t(document).scrollTop(),r=t(document).scrollLeft(),h=i.top-a,p=i.left-r;return h-5<0||p-5<0||h+e+5>s||p+o+5>n},o.prototype.speak=function(t,i,e){this._hidden=!1,this.show();var o=this._content;o.height("auto"),o.width("auto"),o.text(i),o.height(o.height()),o.width(o.width()),o.text(""),this.reposition(),this._complete=t,this._sayWords(i,e,t)},o.prototype.show=function(){this._hidden||this._balloon.show()},o.prototype.hide=function(i){i?this._balloon.hide():this._hiding=window.setTimeout(t.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY)},o.prototype._finishHideBalloon=function(){this._active||(this._balloon.hide(),this._hidden=!0,this._hiding=null)},o.prototype._sayWords=function(i,e,o){this._active=!0,this._hold=e;var n=i.split(/[^\S-]/),s=this.WORD_SPEAK_TIME,a=this._content,r=1;this._addWord=t.proxy(function(){this._active&&(r>n.length?(delete this._addWord,this._active=!1,this._hold||(o(),this.hide())):(a.text(n.slice(0,r).join(" ")),r++,this._loop=window.setTimeout(t.proxy(this._addWord,this),s)))},this),this._addWord()},o.prototype.close=function(){this._active?this._hold=!1:this._hold&&this._complete()},o.prototype.pause=function(){window.clearTimeout(this._loop),this._hiding&&(window.clearTimeout(this._hiding),this._hiding=null)},o.prototype.resume=function(){this._addWord?this._addWord():this._hold||this._hidden||(this._hiding=window.setTimeout(t.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY))};var n=function(n,s,a){this.path=n,this._queue=new i(t.proxy(this._onQueueEmpty,this)),this._el=t('<div class="clippy"></div>').hide(),t(document.body).append(this._el),this._animator=new e(this._el,n,s,a),this._balloon=new o(this._el),this._setupEvents()};n.prototype.gestureAt=function(t,i){var e=this._getDirection(t,i),o="Gesture"+e,n="Look"+e,s=this.hasAnimation(o)?o:n;return this.play(s)},n.prototype.hide=function(t,i){this._hidden=!0;var e=this._el;return this.stop(),t?(this._el.hide(),this.stop(),this.pause(),void(i&&i())):this._playInternal("Hide",function(){e.hide(),this.pause(),i&&i()})},n.prototype.moveTo=function(i,o,n){var s="Move"+this._getDirection(i,o);void 0===n&&(n=1e3),this._addToQueue(function(a){if(0===n)return this._el.css({top:o,left:i}),this.reposition(),void a();if(this.hasAnimation(s)){var r=t.proxy(function(s,r){r===e.States.EXITED&&a(),r===e.States.WAITING&&this._el.animate({top:o,left:i},n,t.proxy(function(){this._animator.exitAnimation()},this))},this);this._playInternal(s,r)}else this._el.animate({top:o,left:i},n,a)},this)},n.prototype._playInternal=function(i,e){this._isIdleAnimation()&&this._idleDfd&&"pending"===this._idleDfd.state()&&this._idleDfd.done(t.proxy(function(){this._playInternal(i,e)},this)),this._animator.showAnimation(i,e)},n.prototype.play=function(i,o,n){return!!this.hasAnimation(i)&&(void 0===o&&(o=5e3),this._addToQueue(function(s){var a=!1;o&&window.setTimeout(t.proxy(function(){a||this._animator.exitAnimation()},this),o),this._playInternal(i,function(t,i){i===e.States.EXITED&&(a=!0,n&&n(),s())})},this),!0)},n.prototype.show=function(i){if(this._hidden=!1,i)return this._el.show(),this.resume(),void this._onQueueEmpty();if("auto"===this._el.css("top")||"auto"===!this._el.css("left")){var e=.8*t(window).width(),o=.8*(t(window).height()+t(document).scrollTop());this._el.css({top:o,left:e})}return this.resume(),this.play("Show")},n.prototype.speak=function(t,i){this._addToQueue(function(e){this._balloon.speak(e,t,i)},this)},n.prototype.closeBalloon=function(){this._balloon.hide()},n.prototype.delay=function(t){t=t||250,this._addToQueue(function(i){this._onQueueEmpty(),window.setTimeout(i,t)})},n.prototype.stopCurrent=function(){this._animator.exitAnimation(),this._balloon.close()},n.prototype.stop=function(){this._queue.clear(),this._animator.exitAnimation(),this._balloon.hide()},n.prototype.hasAnimation=function(t){return this._animator.hasAnimation(t)},n.prototype.animations=function(){return this._animator.animations()},n.prototype.animate=function(){var t=this.animations(),i=t[Math.floor(Math.random()*t.length)];return 0===i.indexOf("Idle")?this.animate():this.play(i)},n.prototype._getDirection=function(t,i){var e=this._el.offset(),o=this._el.height(),n=this._el.width(),s=Math.round(180*Math.atan2(e.top+o/2-i,e.left+n/2-t)/Math.PI);return-45<=s&&s<45?"Right":45<=s&&s<135?"Up":135<=s&&s<=180||-180<=s&&s<-135?"Left":-135<=s&&s<-45?"Down":"Top"},n.prototype._onQueueEmpty=function(){if(!this._hidden&&!this._isIdleAnimation()){var i=this._getIdleAnimation();this._idleDfd=t.Deferred(),this._animator.showAnimation(i,t.proxy(this._onIdleComplete,this))}},n.prototype._onIdleComplete=function(t,i){i===e.States.EXITED&&this._idleDfd.resolve()},n.prototype._isIdleAnimation=function(){var t=this._animator.currentAnimationName;return t&&0===t.indexOf("Idle")},n.prototype._getIdleAnimation=function(){for(var t=this.animations(),i=[],e=0;e<t.length;e++){var o=t[e];0===o.indexOf("Idle")&&i.push(o)}return i[Math.floor(Math.random()*i.length)]},n.prototype._setupEvents=function(){t(window).on("resize",t.proxy(this.reposition,this)),this._el.on("mousedown",t.proxy(this._onMouseDown,this)),this._el.on("dblclick",t.proxy(this._onDoubleClick,this))},n.prototype._onDoubleClick=function(){this.play("ClickedOn")||this.animate()},n.prototype.reposition=function(){if(this._el.is(":visible")){var i=this._el.offset(),e=this._el.outerHeight(),o=this._el.outerWidth(),n=t(window).width(),s=t(window).height(),a=t(window).scrollTop(),r=t(window).scrollLeft(),h=i.top-a,p=i.left-r;h-5<0?h=5:h+e+5>s&&(h=s-e-5),p-5<0?p=5:p+o+5>n&&(p=n-o-5),this._el.css({left:p,top:h}),this._balloon.reposition()}},n.prototype._onMouseDown=function(t){t.preventDefault(),this._startDrag(t)},n.prototype._startDrag=function(i){this.pause(),this._balloon.hide(!0),this._offset=this._calculateClickOffset(i),this._moveHandle=t.proxy(this._dragMove,this),this._upHandle=t.proxy(this._finishDrag,this),t(window).on("mousemove",this._moveHandle),t(window).on("mouseup",this._upHandle),this._dragUpdateLoop=window.setTimeout(t.proxy(this._updateLocation,this),10)},n.prototype._calculateClickOffset=function(t){var i=t.pageX,e=t.pageY,o=this._el.offset();return{top:e-o.top,left:i-o.left}},n.prototype._updateLocation=function(){this._el.css({top:this._targetY,left:this._targetX}),this._dragUpdateLoop=window.setTimeout(t.proxy(this._updateLocation,this),10)},n.prototype._dragMove=function(t){t.preventDefault();var i=t.clientY-this._offset.top;this._targetX=t.clientX-this._offset.left,this._targetY=i},n.prototype._finishDrag=function(){window.clearTimeout(this._dragUpdateLoop),t(window).off("mousemove",this._moveHandle),t(window).off("mouseup",this._upHandle),this._balloon.show(),this.reposition(),this.resume()},n.prototype._addToQueue=function(i,e){e&&(i=t.proxy(i,e)),this._queue.queue(i)},n.prototype.pause=function(){this._animator.pause(),this._balloon.pause()},n.prototype.resume=function(){this._animator.resume(),this._balloon.resume()};var s=function i(e,o,s,a){var r,h,p=(a=a||window.CLIPPY_CDN||"https://gitcdn.xyz/repo/pi0/clippyjs/master/assets/agents/")+e,u=i._loadMap(p),l=i._loadAgent(e,p),_=i._loadSounds(e,p);l.done(function(t){r=t}),_.done(function(t){h=t}),t.when(u,l,_).done(function(){var t=new n(p,r,h);o(t)}).fail(s)};s._loadMap=function(i){var e=s._maps[i];if(e)return e;e=s._maps[i]=t.Deferred();var o=i+"/map.png",n=new Image;return n.onload=e.resolve,n.onerror=e.reject,n.setAttribute("src",o),e.promise()},s._loadSounds=function(i,e){var o=s._sounds[i];if(o)return o;o=s._sounds[i]=t.Deferred();var n=document.createElement("audio"),a=!!n.canPlayType&&""!==n.canPlayType("audio/mpeg"),r=!!n.canPlayType&&""!==n.canPlayType('audio/ogg; codecs="vorbis"');return a||r?s._loadScript(e+(a?"/sounds-mp3.js":"/sounds-ogg.js")):o.resolve({}),o.promise()},s._loadAgent=function(t,i){var e=s._data[t];return e||(e=s._getAgentDfd(t),s._loadScript(i+"/agent.js"),e.promise())},s._loadScript=function(t){var i=document.createElement("script");i.setAttribute("src",t),i.setAttribute("async","async"),i.setAttribute("type","text/javascript"),document.head.appendChild(i)},s._getAgentDfd=function(i){var e=s._data[i];return e||(e=s._data[i]=t.Deferred()),e},s._maps={},s._sounds={},s._data={};var a={Agent:n,Animator:e,Queue:i,Balloon:o,load:s,ready:function(t,i){s._getAgentDfd(t).resolve(i)},soundsReady:function(i,e){var o=s._sounds[i];o||(o=s._sounds[i]=t.Deferred()),o.resolve(e)}};return"undefined"!=typeof window&&(window.clippy=a),a});